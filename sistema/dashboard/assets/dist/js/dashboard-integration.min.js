class DashboardIntegration{constructor(){this.manualControl=null;this.expertzyCharts=null;this.isInitialized=false;this.init()}async init(){await this.waitForSystems();this.setupIntegrations();this.setupEventListeners();this.isInitialized=true;console.log('‚úÖ DashboardIntegration inicializado')}async waitForSystems(){let attempts=0;while(!window.manualControlSystem && attempts < 50){await new Promise(resolve=> setTimeout(resolve,100));attempts++}if(window.manualControlSystem){this.manualControl=window.manualControlSystem;console.log('‚úÖ Manual Control System conectado')}else{console.error('‚ùå Manual Control System n√£o encontrado');return}attempts=0;while(!window.expertzyCharts && attempts < 30){await new Promise(resolve=> setTimeout(resolve,100));attempts++}if(window.expertzyCharts){this.expertzyCharts=window.expertzyCharts;console.log('‚úÖ Expertzy Charts System conectado')}else{console.warn('‚ö†Ô∏è Expertzy Charts System n√£o encontrado(opcional)')}}setupIntegrations(){if(!this.manualControl)return;this.integrateWithCharts();this.integrateWithDashboard();this.setupIntelligentAutoRefresh();this.setupConditionalValidations()}integrateWithCharts(){if(!this.expertzyCharts)return;const state=this.manualControl.getState();const feedback=this.manualControl.getFeedback();const originalLoadChartData=this.expertzyCharts.loadChartData;this.expertzyCharts.loadChartData=async function(manualTrigger=false){if(!manualTrigger && !state.canLoadCharts()){console.log('üö´ Carregamento autom√°tico bloqueado-dados insuficientes');this.showEmptyStates();return}if(manualTrigger && !state.canLoadCharts()){feedback.showToast('N√£o √© poss√≠vel carregar gr√°ficos','warning',{subtitle:'Verifique se h√° dados suficientes no banco'});return}try{await originalLoadChartData.call(this,manualTrigger);state.updateChartsState({loaded:true,types:state.charts.available_types,last_load:new Date().toISOString()})}catch(error){console.error('Erro no carregamento dos gr√°ficos:',error);feedback.showToast('Erro ao carregar gr√°ficos','error')}};const originalRefreshChart=this.expertzyCharts.refreshChart;this.expertzyCharts.refreshChart=async function(chartType,manualTrigger=false){if(!manualTrigger){console.log(`üö´ Refresh autom√°tico de ${chartType}bloqueado`);return}return originalRefreshChart.call(this,chartType,manualTrigger)};window.loadChartsManually=()=>{if(this.expertzyCharts){return this.expertzyCharts.loadChartData(true)}else{feedback.showToast('Sistema de gr√°ficos n√£o dispon√≠vel','error')}};console.log('‚úÖ Integra√ß√£o com Charts System configurada')}integrateWithDashboard(){const state=this.manualControl.getState();const feedback=this.manualControl.getFeedback();if(typeof window.refreshAllCharts==='function'){const originalRefreshAll=window.refreshAllCharts;window.refreshAllCharts=function(){if(!state.canLoadCharts()){feedback.showToast('Sistema n√£o pronto para refresh completo','warning',{subtitle:'Verifique status do banco de dados'});return}return window.manualControlSystem.forceRefresh()}}if(typeof window.loadStatsCards==='function'){const originalLoadStats=window.loadStatsCards;window.loadStatsCards=function(){if(!state.canLoadStats()){feedback.showToast('Dados insuficientes para estat√≠sticas','warning');return}return originalLoadStats()}}console.log('‚úÖ Integra√ß√£o com Dashboard configurada')}setupIntelligentAutoRefresh(){const autoRefresh=this.manualControl.getAutoRefresh();const state=this.manualControl.getState();autoRefresh.setCallbacks({onRefresh:async()=>{if(state.canLoadCharts()|| state.canLoadStats()){return this.manualControl.forceRefresh()}else{console.log('üîÑ Auto-refresh pulado-sistema n√£o pronto');return Promise.resolve()}},onStart:(interval)=>{console.log(`üîÑ Auto-refresh inteligente iniciado(${interval/1000}s)`)},onError:(error)=>{console.error('Erro no auto-refresh:',error);if(error.message.includes('HTTP 5')){autoRefresh.stop();this.manualControl.getFeedback().showToast('Auto-refresh pausado devido a erro no servidor','warning',{persistent:true})}}});console.log('‚úÖ Auto-refresh inteligente configurado')}setupConditionalValidations(){const state=this.manualControl.getState();state.on('database-changed',(newState,oldState)=>{this.updateUIBasedOnDatabaseChange(newState,oldState)});state.on('charts-loaded',(chartsState)=>{this.updateChartsUI(chartsState)});state.on('operation-started',(operationId)=>{this.updateOperationUI(operationId,'started')});state.on('operation-completed',(operationId,result)=>{this.updateOperationUI(operationId,'completed',result)});console.log('‚úÖ Valida√ß√µes condicionais configuradas')}setupEventListeners(){document.addEventListener('chartsDataUpdated',(event)=>{console.log('üìä Dados de gr√°ficos atualizados via evento',event.detail)});document.addEventListener('click',(event)=>{if(event.target.closest('.chart-control-btn[data-action="refresh"]')){const chartContainer=event.target.closest('[data-chart]');if(chartContainer){const chartType=chartContainer.dataset.chart;this.handleIndividualChartRefresh(chartType)}}});this.setupFiltersIntegration();console.log('‚úÖ Event listeners configurados')}setupFiltersIntegration(){const filterElements={period:document.getElementById('periodFilter'),currency:document.getElementById('currencyFilter'),state:document.getElementById('stateFilter'),taxRegime:document.getElementById('taxRegimeFilter')};Object.entries(filterElements).forEach(([type,element])=>{if(element){element.addEventListener('change',()=>{if(this.manualControl.getState().charts.loaded){this.applyFiltersToCharts()}})}})}updateUIBasedOnDatabaseChange(newState,oldState){const indicators=document.querySelectorAll('[data-status-indicator]');indicators.forEach(indicator=>{const type=indicator.dataset.statusIndicator;switch(type){case 'database':indicator.className=`status-indicator ${newState.connected ? 'success':'error'}`;break;case 'data':indicator.className=`status-indicator ${newState.sufficient ? 'success':'warning'}`;break}});const disCounters=document.querySelectorAll('[data-counter="dis"]');disCounters.forEach(counter=>{counter.textContent=newState.dis_count.toLocaleString('pt-BR')});if(oldState.dis_count !==newState.dis_count){const change=newState.dis_count-oldState.dis_count;if(change > 0){this.manualControl.getFeedback().showToast(`${change}nova(s)DI(s)detectada(s)`,'info',{subtitle:`Total:${newState.dis_count}`})}}}updateChartsUI(chartsState){const chartContainers=document.querySelectorAll('[data-chart]');chartContainers.forEach(container=>{if(chartsState.loaded){container.setAttribute('data-state','loaded');const emptyState=container.querySelector('.chart-empty');if(emptyState){emptyState.style.display='none'}}});const filterControls=document.querySelector('.charts-filters');if(filterControls && chartsState.loaded){filterControls.classList.remove('disabled')}}updateOperationUI(operationId,status,result=null){const button=document.getElementById(operationId.replace('-',''));if(button){switch(status){case 'started':button.disabled=true;button.classList.add('loading');break;case 'completed':button.disabled=false;button.classList.remove('loading');if(result && !result.success){button.classList.add('error');setTimeout(()=>{button.classList.remove('error')},3000)}break}}}async handleIndividualChartRefresh(chartType){const state=this.manualControl.getState();if(!state.canLoadCharts()){this.manualControl.getFeedback().showToast(`N√£o √© poss√≠vel atualizar gr√°fico ${chartType}`,'warning',{subtitle:'Dados insuficientes'});return}try{if(this.expertzyCharts){await this.expertzyCharts.refreshChart(chartType,true);this.manualControl.getFeedback().showToast(`Gr√°fico ${chartType}atualizado`,'success')}}catch(error){console.error(`Erro ao atualizar gr√°fico ${chartType}:`,error);this.manualControl.getFeedback().showToast(`Erro ao atualizar gr√°fico ${chartType}`,'error')}}applyFiltersToCharts(){if(this.expertzyCharts && typeof this.expertzyCharts.applyFilters==='function'){const filters=this.getSelectedFilters();this.expertzyCharts.applyFilters(filters)}}getSelectedFilters(){const filters={};const periodActive=document.querySelector('#periodFilter .toggle-option.active');if(periodActive){filters.period=periodActive.dataset.period}const currencySelect=document.getElementById('currencyFilter');if(currencySelect){filters.currency=currencySelect.value}const stateSelect=document.getElementById('stateFilter');if(stateSelect){filters.state=stateSelect.value}const regimeActive=document.querySelector('#taxRegimeFilter .toggle-option.active');if(regimeActive){filters.taxRegime=regimeActive.dataset.regime}return filters}getManualControl(){return this.manualControl}getChartsSystem(){return this.expertzyCharts}isReady(){return this.isInitialized && this.manualControl !==null}async forceSystemRefresh(){if(this.manualControl){return this.manualControl.forceRefresh()}}getSystemStatus(){if(!this.manualControl)return null;const state=this.manualControl.getState();return{database:state.database,charts:state.charts,stats:state.stats,autoRefresh:state.autoRefresh,canLoadCharts:state.canLoadCharts(),canLoadStats:state.canLoadStats(),nextAction:state.getNextRecommendedAction()}}}let dashboardIntegration;function initDashboardIntegration(){if(window.dashboardIntegration){console.warn('DashboardIntegration j√° foi inicializado');return window.dashboardIntegration}dashboardIntegration=new DashboardIntegration();window.dashboardIntegration=dashboardIntegration;window.getSystemStatus=()=> dashboardIntegration.getSystemStatus();window.forceSystemRefresh=()=> dashboardIntegration.forceSystemRefresh();console.log('‚úÖ DashboardIntegration inicializado e exposto globalmente');return dashboardIntegration}if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',()=>{setTimeout(initDashboardIntegration,100)})}else{setTimeout(initDashboardIntegration,100)}if(typeof module !=='undefined' && module.exports){module.exports=DashboardIntegration}